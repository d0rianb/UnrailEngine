var __defProp=Object.defineProperty,__hasOwnProp=Object.prototype.hasOwnProperty,__getOwnPropSymbols=Object.getOwnPropertySymbols,__propIsEnum=Object.prototype.propertyIsEnumerable,__defNormalProp=(t,e,i)=>e in t?__defProp(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,__assign=(t,e)=>{for(var i in e||(e={}))__hasOwnProp.call(e,i)&&__defNormalProp(t,i,e[i]);if(__getOwnPropSymbols)for(var i of __getOwnPropSymbols(e))__propIsEnum.call(e,i)&&__defNormalProp(t,i,e[i]);return t};!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self)["unrail-engine"]={})}(this,(function(t){"use strict";class e{static random(){return Math.random()}static randint(t,e){return Math.floor(t+Math.random()*(e-t))}static choice(t){return t[~~(e.random()*t.length)]}static bool(){return e.random()>.5}static sign(){return e.choice([-1,1])}static percent(t){return e.random()<t/100}}var i=e;class s{constructor(t,e){this.x=t,this.y=e}add(t){return new s(this.x+t.x,this.y+t.y)}clone(){return new s(this.x,this.y)}dist(t){return Math.sqrt((this.x-t.x)**2+(this.y-t.y)**2)}}const n=s,o=new s(0,0),r=new s(1,1);function a(t,e,i){return Math.max(t,Math.min(e,i))}function l(t,e,i){return a(e,t,i)===t}var c,h;(h=c||(c={}))[h.KeyboardPressed=0]="KeyboardPressed",h[h.KeyboardDown=1]="KeyboardDown",h[h.Mouse=2]="Mouse",h[h.Window=3]="Window",h[h.Custom=4]="Custom";class d{constructor(t,e,i=4){this.name=t,this.callback=e,this.type=i,this.listeners=[this.callback]}static emit(t,e){const i=u.getCustomEvent(t);i&&i.listeners.forEach((t=>t(e)))}static on(t,e){const i=u.getCustomEvent(t);if(i)i.listeners.push(e);else{const i=new d(t,e,4);u.addEvent(i)}}static onKeyDown(t,e){u.addEvent(new d(t,e,1))}static onKeyPressed(t,e){u.addEvent(new d(t,e,0))}static onMouseClick(t){u.addEvent(new d("click",t,2))}}const u=new class{constructor(){this.windowEvents=[],this.keyboardDownEvents=[],this.keyboardPressedEvents=[],this.customEvents=[],this.currentKeyEvents=[]}init(){window.addEventListener("keydown",(t=>{this.currentKeyEvents.find((e=>e.code===t.code))||this.currentKeyEvents.push(t),this.keyboardPressedEvents.forEach((e=>{t.code===e.name&&e.callback(t)}))})),window.addEventListener("keyup",(t=>{this.currentKeyEvents.length&&(this.currentKeyEvents=this.currentKeyEvents.filter((e=>e.code!==t.code)))}))}addEvent(t){switch(t.type){case c.KeyboardDown:this.keyboardDownEvents.push(t);case c.KeyboardPressed:this.keyboardPressedEvents.push(t);case c.Mouse:break;case c.Window:this.windowEvents.push(t),this.bindEvents();case c.Custom:this.customEvents.push(t)}}getCustomEvent(t){return this.customEvents.find((e=>e.name===t))}bindEvents(){this.windowEvents.forEach((t=>window.addEventListener(t.name,t.callback)))}tick(){this.currentKeyEvents.length&&this.keyboardDownEvents.forEach((t=>{this.currentKeyEvents.forEach((e=>{e.code===t.name&&t.callback(e)}))}))}};"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var p,f=(function(t,e){var i;t.exports=((i=function(){function t(t){return n.appendChild(t.dom),t}function e(t){for(var e=0;e<n.children.length;e++)n.children[e].style.display=e===t?"block":"none";s=t}var s=0,n=document.createElement("div");n.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",n.addEventListener("click",(function(t){t.preventDefault(),e(++s%n.children.length)}),!1);var o=(performance||Date).now(),r=o,a=0,l=t(new i.Panel("FPS","#0ff","#002")),c=t(new i.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var h=t(new i.Panel("MB","#f08","#201"));return e(0),{REVISION:16,dom:n,addPanel:t,showPanel:e,begin:function(){o=(performance||Date).now()},end:function(){a++;var t=(performance||Date).now();if(c.update(t-o,200),t>r+1e3&&(l.update(1e3*a/(t-r),100),r=t,a=0,h)){var e=performance.memory;h.update(e.usedJSHeapSize/1048576,e.jsHeapSizeLimit/1048576)}return t},update:function(){o=this.end()},domElement:n,setMode:e}}).Panel=function(t,e,i){var s=1/0,n=0,o=Math.round,r=o(window.devicePixelRatio||1),a=80*r,l=48*r,c=3*r,h=2*r,d=3*r,u=15*r,p=74*r,f=30*r,y=document.createElement("canvas");y.width=a,y.height=l,y.style.cssText="width:80px;height:48px";var m=y.getContext("2d");return m.font="bold "+9*r+"px Helvetica,Arial,sans-serif",m.textBaseline="top",m.fillStyle=i,m.fillRect(0,0,a,l),m.fillStyle=e,m.fillText(t,c,h),m.fillRect(d,u,p,f),m.fillStyle=i,m.globalAlpha=.9,m.fillRect(d,u,p,f),{dom:y,update:function(l,w){s=Math.min(s,l),n=Math.max(n,l),m.fillStyle=i,m.globalAlpha=1,m.fillRect(0,0,a,u),m.fillStyle=e,m.fillText(o(l)+" "+t+" ("+o(s)+"-"+o(n)+")",c,h),m.drawImage(y,d+r,u,p-r,f,d,u,p-r,f),m.fillRect(d+p-r,u,r,f),m.fillStyle=i,m.globalAlpha=.9,m.fillRect(d+p-r,u,r,o((1-l/w)*f))}}},i)}(p={exports:{}},p.exports),p.exports);function y(t,e,i,s){const n=i||window.devicePixelRatio||1,o=document.createElement("canvas");return 1!=n&&(o.width=t*n,o.height=e*n,o.style.width=t+"px",o.style.height=e+"px",o.getContext("2d").setTransform(n,0,0,n,0,0)),s&&(o.oncontextmenu=t=>t.preventDefault()),o}function m(t,e){window.onload=()=>{let i=document.querySelector(e);i||(i=document.createElement(e)),i.appendChild(t),document.querySelector("body").appendChild(i)}}const w={strokeStyle:"black",lineWidth:2,lineJoin:"round",fillStyle:"transparent",globalAlpha:1,globalCompositeOperation:"add"};let g=4;try{g=2*(window.devicePixelRatio||1)}catch(H){}function v(t){return~~(t*g)/g}let x=null;class b{static create(t,e){const i=y(t,e);return m(i,"main"),b.setContext(i.getContext("2d")),i}static setContext(t){x=t}static getContext(){return x}static style(t){if(!x)throw new Error("Context has not been initialize. Please use Renderer.setContext");const e=__assign(__assign({},w),t);for(let i in e)x[i]!==e[i]&&(x[i]=e[i])}static clear(t){t?(b.style({fillStyle:t}),x.fillRect(0,0,x.canvas.width,x.canvas.height)):x.clearRect(0,0,x.canvas.width,x.canvas.height)}static line(t,e,i){b.style(i),x.beginPath(),x.moveTo(v(t.x),v(t.y)),x.lineTo(v(e.x),v(e.y)),x.stroke()}static rect(t,e,i,s,n,o){o||b.style(n);const[r,a,l,c]=[v(t),v(e),v(i),v(s)];x.fillRect(r,a,l,c),x.strokeRect(r,a,l,c)}static poly(t,e){if(t.length){b.style(e),x.beginPath(),x.moveTo(v(t[0].x),v(t[0].y));for(let e=1;e<t.length;e++)x.lineTo(v(t[e].x),v(t[e].y));x.stroke()}}static circle(t,e,i,s){b.style(s),x.beginPath(),x.arc(v(t),v(e),i,0,2*Math.PI),x.stroke()}static point(t,e,i){b.circle(t,e,5,i)}static rectSprite(t,e,i,s,n){b.style({}),x.save(),x.translate(v(t+i/2),v(e+s/2)),x.scale(n.scale.x,n.scale.y),x.rotate(n.rotation),x.drawImage(n.image,v(i*n.offset.x-i/2),v(s*n.offset.y-s/2),v(i),v(s)),x.restore()}static circleSprite(t,e,i,s){x.save(),x.beginPath(),x.arc(v(t),v(e),i,0,2*Math.PI),x.clip(),b.rectSprite(t-i,e-i,2*i,2*i,s),x.restore()}static tint(t,e,i,s,n){b.rect(e,i,s,n,{fillStyle:t,globalCompositeOperation:"multiply",globalAlpha:.25})}}class E{constructor(t,e){this.title=t,this.content=e}}let P=null,S=null,k=null;const _=new Map;function C(t,e,i){S.postMessage(new E(t,e),i||[])}function T(t,e){C("render",{method:t,args:e})}class M{static create(t,e){return k=y(t,e,1),M.transferTo(k,t,e),m(k,"main"),k}static transferTo(t,e,i){P=t.transferControlToOffscreen();let{clientWidth:s,clientHeight:n}=t;"offscreen"!==W.rendererType&&W.setRendererType("offscreen"),M.initRenderWorker(e||s,i||n)}static initRenderWorker(t,e){S=new Worker("./src/render/offscreen-renderer/renderer-worker.ts",{type:"module"}),C("initCanvas",{canvas:P,width:t,height:e,dpr:window.devicePixelRatio||1},[P]),S.onmessage=t=>{console.log("message from the worker : ",t.data)}}static style(t){T("style",t)}static clear(t){T("clear",t)}static line(t,e,i){T("line",{point1:t,point2:e,obj:i})}static rect(t,e,i,s,n,o){T("rect",{x:t,y:e,width:i,height:s,obj:n,noStyle:o})}static poly(t,e){T("poly",{points:t,obj:e})}static circle(t,e,i,s){T("circle",{x:t,y:e,radius:i,obj:s})}static point(t,e,i){T("point",{x:t,y:e,obj:i})}static rectSprite(t,e,i,s,n){n.id in _?T("rectSprite",{x:t,y:e,width:i,height:s,texture:_[n.id]}):n.convertToBitmap().then((t=>_[n.id]=t))}static async circleSprite(t,e,i,s){if(s.id in _)T("circleSprite",{x:t,y:e,radius:i,texture:_[s.id]});else{const n=await s.convertToBitmap();_[s.id]=n,T("circleSprite",{x:t,y:e,radius:i,texture:n})}}static tint(t,e,i,s,n){T("circle",{color:t,x:e,y:i,width:s,height:n})}}let R=0;let I=[],O=4;const D=["top-left","top-right","bottom-left","bottom-right","custom"];class L{static addItem(t,e,i){const s={callback:t,position:e,options:i};I.push(s);const n=I.length;window.addEventListener("load",(()=>L.addToDom(s,n)))}static init(){const t=document.createElement("div");t.classList.add("ue-interface","ue-container");for(let e of D){const i=document.createElement("div");i.classList.add(e),t.appendChild(i)}document.body.appendChild(t)}static addToDom(t,e){var i,s;const n=t.callback(),o=document.createElement("span");o.classList.add("ue-interface-items"),o.id=`item-${e}`,o.innerText=n,Object.entries(t.options||{}).forEach((([t,e])=>o.style[t]=e)),t.position?null==(i=document.querySelector(`.ue-container > .${t.position}`))||i.appendChild(o):null==(s=document.querySelector(".ue-container > .custom"))||s.appendChild(o)}static update(){I.forEach(((t,e)=>{const i=t.callback(),s=document.querySelector(`.ue-interface #item-${e+1}`);s&&s.innerText!==i&&(s.innerText=i)}))}static statsShift(t){const e=document.querySelector(".top-left");e&&(e.style.top=`${t}px`)}static setUpdateInterval(t){O=t}static get updateInterval(){return O}}function K(){const t=new f,e=document.createElement("div");return e.classList.toggle("stats"),t.showPanel(0),e.appendChild(t.dom),document.body.appendChild(e),L.statsShift(48),t}let j="normal";class W{constructor(t,e){this.name=t,this.env=e,this.tick=0,this.stats=null,this.showStatsPanel=!0}static setRendererType(t){j=t}static get rendererType(){return j}toggleStats(t){this.showStatsPanel=void 0!==t?t:!this.showStatsPanel,this.showStatsPanel?this.stats=K():(this.stats=null,document.querySelector(".stats")&&document.querySelector(".stats").remove())}setMainLoop(t){this.gameLoop=t}update(t){var e,i;null==(e=this.stats)||e.begin(),u.tick(),this.gameLoop(t),this.tick%L.updateInterval==0&&L.update(),null==(i=this.stats)||i.end(),window.requestAnimationFrame((t=>this.update(t)))}start(){if(!this.gameLoop)throw new Error("No game loop");window.addEventListener("DOMContentLoaded",(()=>{this.name&&(document.title=this.name),u.init(),L.init(),this.showStatsPanel&&(this.stats=K()),this.update(0)}))}}class N{constructor(t,e){this.x=t,this.y=e}collide(t){return!!(t.width&&t.height&&this.width&&this.height)&&(this.x<t.x+t.width&&this.x+this.width>t.x&&this.y<t.y+t.height&&this.height+this.y>t.y)}update(...t){}render(t,...e){}}class U{constructor(t,e){this.delay=t,this.callback=e,window.setTimeout(this.callback,this.delay)}}class q extends N{constructor(t,e,i=5,n,o){super(e.x,e.y),this.id=t,this.pos=e.clone(),this.angle=n&&"random"!=n?n%2*Math.PI:Math.PI/2+2*Math.random()*Math.PI,this.velocity=new s(Math.random()*i*Math.cos(this.angle),Math.random()*i*Math.sin(this.angle)),this.color=o||"red",this.opacity=a(100,255*Math.random(),255),this.radius=2}update(){this.velocity.y+=.01,this.pos=this.pos.add(this.velocity),this.opacity--}render(){switch(W.rendererType){case"normal":b.circle(this.pos.x,this.pos.y,this.radius,{fillStyle:this.color,lineWidth:1,globalAlpha:this.opacity/255});break;case"offscreen":M.circle(this.pos.x,this.pos.y,this.radius,{fillStyle:this.color,lineWidth:1,globalAlpha:this.opacity/255})}}}var A,G;(G=A||(A={}))[G.Turret=0]="Turret",G[G.Road=1]="Road",G[G.Ground=2]="Ground",G[G.Empty=3]="Empty";class B{constructor(t,e,i=1,s=1){this.x=t,this.y=e,this.width=i,this.height=s,this.highlight=!1,this.type=2,this.neighboor={}}toggleHighlight(){this.highlight=!this.highlight}}t.Cell=B,t.Config={},t.Cooldown=U,t.Event=d,t.Game=W,t.GameEnvironement=class{constructor(t,e){this.width=t,this.height=e}update(){}render(){}},t.GameObject=N,t.Grid=class{constructor(t,e){this.rows=e,this.cols=t,this.cells=[],this.focusCell=null,this.createCells(),this.defineNeighboors()}createCells(){for(let t=0;t<this.cols;t++)for(let e=0;e<this.rows;e++)this.cells.push(new B(t,e))}updateCell(t){if(this.cells.includes(t)){if(1!==t.width||1!==t.height){if(t.width>1){let e=t.width-1,i=this.cells.filter((i=>i.y===t.y&&i.x>t.x&&i.x<=t.x+e));this.cells=this.cells.filter((t=>!i.includes(t)))}if(t.height>1){let e=t.height-1,i=this.cells.filter((i=>i.x===t.x&&i.y>t.y&&i.y<=t.y+e));this.cells=this.cells.filter((t=>!i.includes(t)))}}this.defineNeighboors(),this.cells[this.cells.indexOf(t)]=t}}defineNeighboors(){this.cells.forEach((t=>{t.neighboor.top=t.y>=1?this.cells.filter((e=>e.x<=t.x&&e.x+e.width>t.x&&e.y===t.y-t.height))[0]:null,t.neighboor.bottom=t.y<=this.rows-1?this.cells.filter((e=>e.x<=t.x&&e.x+e.width>t.x&&e.y===t.y+t.height))[0]:null,t.neighboor.left=t.x>=1?this.cells.filter((e=>e.y<=t.y&&e.y+e.height>t.y&&e.x===t.x-t.width))[0]:null,t.neighboor.right=t.x<=this.cols-1?this.cells.filter((e=>e.y<=t.y&&e.y+e.height>t.y&&e.x===t.x+t.width))[0]:null}))}},t.Interface=L,t.OffscreenRenderer=M,t.Particle=q,t.ParticuleGenerator=class{constructor(t,e,s,n){this.pos=e,this.lifeDuration=s,this.particles=[],this.UUID=100*i.randint(1,100);for(let i=0;i<t;i++){let t=new q(this.UUID+i,this.pos);this.particles.push(t)}new U(this.lifeDuration,(()=>{this.destroy(),n()}))}addParticles(t){return t.concat(this.particles)}removeParticles(t){const e=this.particles.length;return t.filter((t=>!l(t.id,this.UUID,this.UUID+e)))}destroy(){}},t.PlayerObject=class extends N{constructor(t,e){super(t,e)}update(...t){}render(t,...e){}},t.Point=n,t.Random=i,t.Renderer=b,t.Texture=class{constructor(t,e){if(!t)throw new Error("A source path to the resource must be provided");this.id=R++,this.image=new Image,this.image.src=t,this.size=new s(this.image.width,this.image.height),this.options=e||{},this.rotation=this.options.rotation||0,this.offset=this.options.offset||o,this.scale=this.options.scale||r}async convertToBitmap(){const t=await createImageBitmap(this.image);return __assign(__assign({},this),{image:t})}},t.VERSION="0.1.1",t.V_NULL=o,t.V_UNIT=r,t.Vector2=s,t.clamp=a,t.createCanvas=y,t.getWindowDimensions=function(){return{width:window.innerWidth,height:window.innerHeight}},t.inRange=l,Object.defineProperty(t,"__esModule",{value:!0}),t[Symbol.toStringTag]="Module"}));
